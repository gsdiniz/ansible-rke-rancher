---
- name: MASTER PRINCIPAL DEFINIDO
  assert:
    that:
      - primary_master is defined
      - primary_master in groups['masters']
    fail_msg: "primary_master deve ser um master node"

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
    use: systemd

- name: Remove podman and buildah
  become: true
  ansible.builtin.yum:
    name: 
    - podman
    - buildah
    state: absent
    update_cache: true

- name: Atualiza pacotes
  become: true
  ansible.builtin.yum:
    name: "*"
    state: latest
    update_cache: true

- name: Install pacotes b√°sicos
  ansible.builtin.yum:
    name:
    - curl
    - iscsi-initiator-utils
    - nfs-utils
    - bash
    - cryptsetup
    - device-mapper
    - tar
    - container-selinux
    - libselinux-python3
    - policycoreutils
    - policycoreutils-python-utils
    - selinux-policy-targeted
    state: present

- name: Download and install Calico SELinux policy
  dnf:
    name: https://downloads.tigera.io/ee/archives/calico-selinux-1.0-1.el9.noarch.rpm
    state: present
    disable_gpg_check: yes

- name: Iniciar open-iscsi service
  ansible.builtin.service:
    name: iscsid
    state: started
    enabled: true

- name: Ensure vm.overcommit_memory=1 is in sysctl.conf
  ansible.builtin.lineinfile:
    path: /etc/sysctl.conf
    regexp: '^vm\.overcommit_memory='
    line: 'vm.overcommit_memory=1'
    state: present

- name: Ensure kernel.panic=10 is in sysctl.conf
  ansible.builtin.lineinfile:
    path: /etc/sysctl.conf
    regexp: '^kernel\.panic='
    line: 'kernel.panic=10'
    state: present

- name: Ensure services are disabled
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - firewalld

- name: Ensure flannel and calico interfaces are unmanaged by network manager 
  copy:
    dest: /etc/NetworkManager/conf.d/rke2-canal.conf
    content: | 
      [keyfile]
      unmanaged-devices=interface-name:flannel*;interface-name:cali*
    mode: '0644'

- name: Set SELinux to permissive mode
  ansible.posix.selinux:
    policy: targeted
    state: enforcing

- name: Reboot node
  ansible.builtin.reboot:
  register: reboot_result

- name: Reboot result
  ansible.builtin.debug:
    msg: "The reboot took {{ reboot_result.elapsed }} seconds. Was it successful? {{ reboot_result.rebooted }}"